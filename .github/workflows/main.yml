name: IPTV Update

# 触发条件：定时运行 (每4小时) + 手动按钮
on:
  schedule:
    # 分 时 日 月 周 (UTC时间)
    # */4 表示每 4 小时运行一次
    - cron: '0 */4 * * *'
  workflow_dispatch:

# 【CRITICAL】必须有写权限，否则 git push 会失败
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 设置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    # 3. 安装依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests urllib3

    # 4. 运行 Python 脚本
    - name: Run IPTV Checker
      env:
        # 引用 Secrets
        IPTV_CONFIG: ${{ secrets.IPTV_CONFIG }}
      # [修正] 这里原本是 app.py，已修正为 main.py 以匹配您的脚本文件名
      run: python main.py

    # 5. 提交结果
    - name: Commit and Push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 同时提交 汇总文件(source.m3u) 和 结果文件(valid.m3u)
        # 确保这些文件不在 .gitignore 中
        git add source.m3u valid.m3u
        
        # 提交并推送，无变化则安全退出
        git commit -m "Auto Update: Every 4 hours" || exit 0
        git push
